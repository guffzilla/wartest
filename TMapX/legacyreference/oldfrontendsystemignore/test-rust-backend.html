<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rust Backend Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #ffffff;
        }
        .test-section {
            background: #16213e;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border: 2px solid #0f3460;
        }
        .test-button {
            background: #e94560;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #c73e5a;
        }
        .result {
            background: #0f3460;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success {
            border-left: 4px solid #4caf50;
        }
        .error {
            border-left: 4px solid #f44336;
        }
        .loading {
            border-left: 4px solid #ff9800;
        }
        .oauth-buttons {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .oauth-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .oauth-btn.discord {
            background: #7289da;
        }
        .oauth-btn.twitch {
            background: #9146ff;
        }
        .form-group {
            margin: 10px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #0f3460;
            border-radius: 4px;
            background: #16213e;
            color: white;
        }
    </style>
</head>
<body>
    <h1>üß™ Rust Backend Integration Test</h1>
    
    <div class="test-section">
        <h2>üîó Backend Health Check</h2>
        <button class="test-button" onclick="testHealth()">Test Health Endpoint</button>
        <div id="health-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>üîê OAuth Endpoints</h2>
        <div class="oauth-buttons">
            <button class="test-button" onclick="testOAuthUrl('google')">Test Google OAuth URL</button>
            <button class="test-button" onclick="testOAuthUrl('discord')">Test Discord OAuth URL</button>
            <button class="test-button" onclick="testOAuthUrl('twitch')">Test Twitch OAuth URL</button>
        </div>
        <div id="oauth-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>üë§ User Registration</h2>
        <div class="form-group">
            <label for="reg-username">Username:</label>
            <input type="text" id="reg-username" value="testuser3">
        </div>
        <div class="form-group">
            <label for="reg-email">Email:</label>
            <input type="email" id="reg-email" value="test3@example.com">
        </div>
        <div class="form-group">
            <label for="reg-password">Password:</label>
            <input type="password" id="reg-password" value="testpass123">
        </div>
        <div class="form-group">
            <label for="reg-display-name">Display Name:</label>
            <input type="text" id="reg-display-name" value="Test User 3">
        </div>
        <button class="test-button" onclick="testRegistration()">Test User Registration</button>
        <div id="registration-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>üîë User Login</h2>
        <div class="form-group">
            <label for="login-username">Username:</label>
            <input type="text" id="login-username" value="testuser3">
        </div>
        <div class="form-group">
            <label for="login-password">Password:</label>
            <input type="password" id="login-password" value="testpass123">
        </div>
        <button class="test-button" onclick="testLogin()">Test User Login</button>
        <div id="login-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>üîß Admin Functions</h2>
        <div class="form-group">
            <label for="admin-user-id">User ID:</label>
            <input type="text" id="admin-user-id" placeholder="Enter user ID to promote">
        </div>
        <div class="form-group">
            <label for="admin-role">New Role:</label>
            <input type="text" id="admin-role" value="admin">
        </div>
        <button class="test-button" onclick="testAdminPromote()">Test Admin Promotion</button>
        <div id="admin-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>üìä Current Status</h2>
        <button class="test-button" onclick="showStatus()">Show Current Status</button>
        <div id="status-result" class="result"></div>
    </div>

    <script type="module">
        import authenticationService from './js/services/AuthenticationService.js';
        import apiClient from './js/modules/ApiClient.js';

        // Make services available globally for testing
        window.authService = authenticationService;
        window.apiClient = apiClient;

        // Initialize services
        await authenticationService.init();

        // Test functions
        window.testHealth = async function() {
            const resultDiv = document.getElementById('health-result');
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'Testing health endpoint...';

            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `‚úÖ Health check successful!\n\nStatus: ${data.status}\nMessage: ${data.message}\nTimestamp: ${data.timestamp}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Health check failed: ${error.message}`;
            }
        };

        window.testOAuthUrl = async function(provider) {
            const resultDiv = document.getElementById('oauth-result');
            resultDiv.className = 'result loading';
            resultDiv.textContent = `Testing ${provider} OAuth URL...`;

            try {
                const authUrl = await apiClient.getOAuthUrl(provider);
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `‚úÖ ${provider} OAuth URL generated successfully!\n\nURL: ${authUrl}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå ${provider} OAuth URL failed: ${error.message}`;
            }
        };

        window.testRegistration = async function() {
            const resultDiv = document.getElementById('registration-result');
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'Testing user registration...';

            try {
                const userData = {
                    username: document.getElementById('reg-username').value,
                    email: document.getElementById('reg-email').value,
                    password: document.getElementById('reg-password').value,
                    display_name: document.getElementById('reg-display-name').value
                };

                const result = await apiClient.registerUser(userData);
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `‚úÖ User registration successful!\n\nUser ID: ${result.user.id}\nUsername: ${result.user.username}\nRole: ${result.user.role}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå User registration failed: ${error.message}`;
            }
        };

        window.testLogin = async function() {
            const resultDiv = document.getElementById('login-result');
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'Testing user login...';

            try {
                const credentials = {
                    username: document.getElementById('login-username').value,
                    password: document.getElementById('login-password').value
                };

                const result = await apiClient.loginUser(credentials);
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `‚úÖ User login successful!\n\nToken: ${result.token.substring(0, 50)}...\nUser: ${result.user.username}\nRole: ${result.user.role}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå User login failed: ${error.message}`;
            }
        };

        window.testAdminPromote = async function() {
            const resultDiv = document.getElementById('admin-result');
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'Testing admin promotion...';

            try {
                const userId = document.getElementById('admin-user-id').value;
                const newRole = document.getElementById('admin-role').value;

                if (!userId) {
                    throw new Error('Please enter a user ID');
                }

                const result = await apiClient.promoteUser(userId, newRole);
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `‚úÖ Admin promotion successful!\n\nUser ID: ${result.user.id}\nNew Role: ${result.user.role}\nMessage: ${result.message}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Admin promotion failed: ${error.message}`;
            }
        };

        window.showStatus = function() {
            const resultDiv = document.getElementById('status-result');
            const authStatus = authenticationService.isUserAuthenticated();
            const currentUser = authenticationService.getCurrentUser();
            const hasToken = !!localStorage.getItem('authToken');

            resultDiv.className = 'result success';
            resultDiv.textContent = `üìä Current Status:\n\nAuthenticated: ${authStatus}\nHas Token: ${hasToken}\nCurrent User: ${currentUser ? JSON.stringify(currentUser, null, 2) : 'None'}`;
        };

        // Auto-run health check on page load
        setTimeout(testHealth, 1000);
    </script>
</body>
</html>
